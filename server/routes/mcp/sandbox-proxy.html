<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <!-- Permissive CSP so nested content is not constrained by host CSP -->
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self'; img-src * data: blob: 'unsafe-inline'; media-src * blob: data:; font-src * blob: data:; script-src 'self' 'wasm-unsafe-eval' 'unsafe-inline' 'unsafe-eval' blob: data: https://cdn.tailwindcss.com https://cdn.jsdelivr.net https://unpkg.com http://localhost:* https://localhost:*; style-src * blob: data: 'unsafe-inline'; connect-src *; frame-src * blob: data: http://localhost:* https://localhost:* http://127.0.0.1:* https://127.0.0.1:*; base-uri 'self';"
    />
    <title>MCP Apps Sandbox Proxy</title>
    <style>
      html,
      body {
        margin: 0;
        height: 100vh;
        width: 100vw;
      }
      body {
        display: flex;
        flex-direction: column;
      }
      * {
        box-sizing: border-box;
      }
      iframe {
        background-color: transparent;
        border: 0px none transparent;
        padding: 0px;
        overflow: hidden;
        flex-grow: 1;
      }
    </style>
  </head>
  <body>
    <script>
      console.log("[Sandbox Proxy] Script loaded - version 2024-12-01-v2");

      /**
       * MCP Apps Sandbox Proxy (SEP-1865)
       *
       * Double-iframe architecture for security isolation:
       * Host Page → Sandbox Proxy (this page, different origin) → Guest UI
       *
       * This proxy:
       * 1. Creates inner iframe immediately
       * 2. Waits for HTML content via ui/notifications/sandbox-resource-ready
       * 3. Builds CSP from metadata and injects into HTML
       * 4. Loads HTML via srcdoc with configurable sandbox attributes
       * 5. Forwards all non-sandbox messages between host and guest
       *
       * Reference: https://gist.github.com/ochafik/a9603ba2d6757d6038ce066eded4c354
       */

      /**
       * Build CSP string from metadata (SEP-1865)
       * @param {Object} csp - CSP metadata with connectDomains and resourceDomains
       * @returns {string} CSP policy string
       */
      function buildCSP(csp) {
        // Default CSP (relaxed for DevX - allows common CDNs)
        // Per SEP-1865, if no CSP declared, use restrictive defaults
        // We use a slightly relaxed default that allows common CDNs for better DevX
        const commonCDNs = "https://cdn.tailwindcss.com https://cdn.jsdelivr.net https://unpkg.com";

        if (!csp) {
          // Relaxed default for DevX - allows common CDNs
          // Note: 'self' doesn't work in srcdoc iframes (refers to about:srcdoc)
          // So we use 'unsafe-inline' and allow common CDNs for scripts/styles
          return [
            "default-src 'none'",
            "script-src 'unsafe-inline' 'unsafe-eval' data: blob: " + commonCDNs,
            "style-src 'unsafe-inline' data: blob: " + commonCDNs,
            "img-src data: blob: " + commonCDNs,
            "font-src data: blob: " + commonCDNs,
            "connect-src *",  // Permissive for dev when no CSP declared
            "frame-src 'none'",
            "object-src 'none'",
            "base-uri 'none'"
          ].join("; ");
        }

        // Build CSP from declared domains
        // Note: For srcdoc iframes, 'self' refers to the parent's origin which doesn't help
        // We use 'unsafe-inline' and 'unsafe-eval' for scripts since all widget code is inline
        const connectDomains = csp.connectDomains || [];
        const resourceDomains = csp.resourceDomains || [];

        // For srcdoc, we need 'unsafe-inline' and 'unsafe-eval' for scripts to work
        // External resources are controlled by resourceDomains
        // Common CDNs are always allowed for widget framework dependencies
        const baseCDNs = "https://cdn.tailwindcss.com https://cdn.jsdelivr.net https://unpkg.com https://esm.sh";

        const connectSrc = connectDomains.length > 0
          ? connectDomains.join(" ")
          : "'none'";  // Block all fetch/XHR if no domains specified
        const resourceSrc = ["data:", "blob:", baseCDNs, ...resourceDomains].join(" ");

        return [
          "default-src 'none'",
          "script-src 'unsafe-inline' 'unsafe-eval' " + resourceSrc,
          "style-src 'unsafe-inline' " + resourceSrc,
          "img-src " + resourceSrc,
          "font-src " + resourceSrc,
          "connect-src " + connectSrc,
          "frame-src 'none'",
          "object-src 'none'",
          "base-uri 'none'"
        ].join("; ");
      }

      /**
       * Inject CSP meta tag into HTML
       * @param {string} html - Original HTML content
       * @param {string} cspValue - CSP policy string
       * @returns {string} HTML with CSP meta tag injected
       */
      function injectCSP(html, cspValue) {
        const cspMeta = '<meta http-equiv="Content-Security-Policy" content="' + cspValue + '">';

        if (html.includes("<head>")) {
          return html.replace("<head>", "<head>" + cspMeta);
        } else if (html.includes("<HEAD>")) {
          return html.replace("<HEAD>", "<HEAD>" + cspMeta);
        } else if (html.includes("<html>")) {
          return html.replace("<html>", "<html><head>" + cspMeta + "</head>");
        } else if (html.includes("<HTML>")) {
          return html.replace("<HTML>", "<HTML><head>" + cspMeta + "</head>");
        } else if (html.includes("<!DOCTYPE") || html.includes("<!doctype")) {
          // Insert after doctype
          return html.replace(/(<!DOCTYPE[^>]*>|<!doctype[^>]*>)/i, "$1<head>" + cspMeta + "</head>");
        } else {
          // Prepend CSP meta tag
          return cspMeta + html;
        }
      }

      // Create inner iframe immediately (before HTML arrives)
      const inner = document.createElement("iframe");
      inner.style = "width:100%; height:100%; border:none;";
      // Default minimal sandbox before HTML arrives
      inner.setAttribute(
        "sandbox",
        "allow-scripts allow-same-origin allow-forms",
      );
      document.body.appendChild(inner);

      // Handle messages from parent (host) and inner (guest UI)
      window.addEventListener("message", async (event) => {
        console.log("[Sandbox Proxy] Message received:", {
          source: event.source === window.parent ? "parent" : event.source === inner.contentWindow ? "inner" : "unknown",
          method: event.data?.method,
          hasParams: !!event.data?.params,
          hasCsp: !!event.data?.params?.csp
        });

        if (event.source === window.parent) {
          // Message from host
          if (
            event.data &&
            event.data.method === "ui/notifications/sandbox-resource-ready"
          ) {
            // Load HTML into inner iframe with CSP enforcement
            const { html, sandbox, csp } = event.data.params || {};

            if (typeof sandbox === "string") {
              inner.setAttribute("sandbox", sandbox);
            }

            if (typeof html === "string") {
              // Build CSP and inject into HTML (SEP-1865)
              console.log("[Sandbox Proxy] Processing HTML with CSP enforcement");
              console.log("[Sandbox Proxy] CSP received:", JSON.stringify(csp));
              console.log("[Sandbox Proxy] CSP truthy?:", !!csp);
              const cspValue = buildCSP(csp);
              console.log("[Sandbox Proxy] CSP value built:", cspValue);
              const processedHtml = injectCSP(html, cspValue);
              console.log("[Sandbox Proxy] Injected CSP meta tag, HTML length:", processedHtml.length);
              console.log("[Sandbox Proxy] First 500 chars:", processedHtml.substring(0, 500));
              inner.srcdoc = processedHtml;
            }
          } else {
            // Forward other messages to inner iframe (guest UI)
            if (inner && inner.contentWindow) {
              inner.contentWindow.postMessage(event.data, "*");
            }
          }
        } else if (event.source === inner.contentWindow) {
          // Relay messages from inner (guest UI) to parent (host)
          window.parent.postMessage(event.data, "*");
        }
      });

      // Notify parent that sandbox is ready (per SEP-1865)
      window.parent.postMessage(
        {
          jsonrpc: "2.0",
          method: "ui/notifications/sandbox-ready",
          params: {},
        },
        "*",
      );
    </script>
  </body>
</html>
